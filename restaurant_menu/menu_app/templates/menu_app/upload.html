<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload PDF</title>
    <script>
        async function uploadPDF(event) {
            event.preventDefault();  // Prevent the default form submission

            const form = document.querySelector('form');
            const formData = new FormData(form);

            try {
                // Send the form data to the server
                const response = await fetch("{% url 'pdf_upload' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",  // Include CSRF token
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('error_message').innerText = errorData.error_message;
                    return;
                }

                const data = await response.json();
                document.getElementById('message').innerText = data.message;
                renderJson(data.output);
                // document.getElementById('output').innerText = data.output;

            } catch (error) {
                console.error("Error uploading PDF:", error);
                document.getElementById('error_message').innerText = "An unexpected error occurred.";
            }
        }
        // This function renders the JSON data as editable form fields
        function renderJson(jsonData) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '';  // Clear any existing content

            // Create a container for the editable JSON
            const jsonContainer = document.createElement('div');
            jsonContainer.classList.add('json-container');
            
            jsonContainer.innerHTML = `
                <h3>Edit Menu Data</h3>
                <div>
                    <label for="page">Page:</label>
                    <input type="number" id="page" value="${jsonData.page}">
                </div>
            `;

            // Loop through sections and create editable fields for each section
            jsonData.sections.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.classList.add('section');
                
                sectionDiv.innerHTML = `
                    <h4>Section: <input type="text" value="${section.section_name}" data-index="${sectionIndex}" class="section-name"></h4>
                    <button onclick="deleteSection(${sectionIndex})">Delete Section</button>
                    <div>
                        <h5>Menu Items:</h5>
                        <div class="menu-items" data-index="${sectionIndex}">
                            ${renderMenuItems(section.menu_items, sectionIndex)}
                        </div>
                        <button onclick="addMenuItem(${sectionIndex})">Add Menu Item</button>
                    </div>
                `;
                jsonContainer.appendChild(sectionDiv);
            });

            // Append the editable JSON to the output container
            outputDiv.appendChild(jsonContainer);
        }

        // This function renders the menu items as editable fields
        function renderMenuItems(menuItems, sectionIndex) {
            return menuItems.map((item, itemIndex) => `
                <div class="menu-item" data-section="${sectionIndex}" data-item="${itemIndex}">
                    <label for="menu_item_name_${itemIndex}">Menu Item:</label>
                    <input type="text" id="menu_item_name_${itemIndex}" value="${item.menu_item}" class="menu-item-name">
                    <label for="menu_item_price_${itemIndex}">Price:</label>
                    <input type="number" id="menu_item_price_${itemIndex}" value="${item.price}" class="menu-item-price">
                    <label for="menu_item_description_${itemIndex}">Description:</label>
                    <input type="text" id="menu_item_description_${itemIndex}" value="${item.description}" class="menu-item-description">
                    <button onclick="deleteMenuItem(${sectionIndex}, ${itemIndex})">Delete Menu Item</button>
                </div>
            `).join('');
        }

        // Function to delete a section
        function deleteSection(sectionIndex) {
            const sectionNameInput = document.querySelectorAll('.section-name')[sectionIndex];
            sectionNameInput.closest('.section').remove();
        }

        // Function to delete a menu item
        function deleteMenuItem(sectionIndex, itemIndex) {
            const menuItemDiv = document.querySelectorAll('.menu-item[data-section="' + sectionIndex + '"][data-item="' + itemIndex + '"]')[0];
            menuItemDiv.remove();
        }

        // Function to add a new menu item
        function addMenuItem(sectionIndex) {
            const newMenuItem = `
                <div class="menu-item" data-section="${sectionIndex}" data-item="new">
                    <label for="menu_item_name_new">Menu Item:</label>
                    <input type="text" id="menu_item_name_new" class="menu-item-name">
                    <label for="menu_item_price_new">Price:</label>
                    <input type="number" id="menu_item_price_new" class="menu-item-price">
                    <label for="menu_item_description_new">Description:</label>
                    <input type="text" id="menu_item_description_new" class="menu-item-description">
                    <button onclick="deleteMenuItem(${sectionIndex}, 'new')">Delete Menu Item</button>
                </div>
            `;
            const menuItemsContainer = document.querySelector(`.menu-items[data-index="${sectionIndex}"]`);
            menuItemsContainer.insertAdjacentHTML('beforeend', newMenuItem);
        }

        // Function to get the updated JSON data from the form
        function getUpdatedJson() {
            const page = document.getElementById('page').value;
            const sections = [];

            document.querySelectorAll('.section').forEach((sectionDiv, sectionIndex) => {
                const sectionName = sectionDiv.querySelector('.section-name').value;
                const menuItems = [];
                
                sectionDiv.querySelectorAll('.menu-item').forEach((menuItemDiv, itemIndex) => {
                    const menuItemName = menuItemDiv.querySelector('.menu-item-name').value;
                    const menuItemPrice = menuItemDiv.querySelector('.menu-item-price').value;
                    const menuItemDescription = menuItemDiv.querySelector('.menu-item-description').value;
                    
                    menuItems.push({
                        menu_item: menuItemName,
                        price: menuItemPrice,
                        description: menuItemDescription
                    });
                });

                sections.push({
                    section_name: sectionName,
                    menu_items: menuItems
                });
            });

            return {
                page: page,
                sections: sections
            };
        }
    </script>
</head>
<body>
    <h1>Upload Menu PDF</h1>

    <p id="error_message" style="color:red;"></p>
    <p id="message" style="color:green;"></p>

    <form method="POST" enctype="multipart/form-data" onsubmit="uploadPDF(event)">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Upload</button>
    </form>

    <p>Response:</p>
    <div id="output"></div>
</body>
</html>