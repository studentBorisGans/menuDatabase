<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Viewer</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
    {{ menu_data|json_script:"menu_data" }}
    <script>
        function toggleDetails(restaurantId) {
            const detailsDiv = document.getElementById(`details-${restaurantId}`);
            if (detailsDiv.style.display === "none") {
                detailsDiv.style.display = "block";
            } else {
                detailsDiv.style.display = "none";
            }
        }

        function loadMenuVersion(menuId) {
            // Render a new HTML file for the menu version
            window.location.href = `/inspect_menu/${menuId}/`;
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="container flex justify-between items-center">
            <nav>
                <ul class="navbar">
                    <li><a href="{%url 'home' %}">Home</a></li>
                    <li><a href="{%url 'about' %}">About</a></li>
                    <li><a href="{% url 'pdf_upload' %}">Upload a Menu</a></li>
                    <li><a href="{% url 'view_uploads' %}">View Menus</a></li>
                </ul>                
            </nav>
        </div>
    </header>

    <h1>Menu Viewer</h1>
    <div id="restaurant-container">
        <!-- Placeholder for dynamically inserted content -->
    </div>

    <script>
        // Replace with JSON data passed from Django
        // Why error???
        const menuData = JSON.parse(document.getElementById('menu_data').textContent);
        console.log(menuData)
        
        const container = document.getElementById('restaurant-container');

        menuData.forEach((restaurant) => {
            const restaurantDiv = document.createElement('div');
            restaurantDiv.className = 'restaurant';

            // Header showing restaurant name, creation date, and number of entries
            const headerDiv = document.createElement('div');
            headerDiv.className = 'restaurant-header';
            headerDiv.style.display = 'flex';
            headerDiv.style.justifyContent = 'space-between';
            headerDiv.style.alignItems = 'center';

            headerDiv.onclick = () => toggleDetails(restaurant.id);
            
            headerDiv.innerHTML = `
                <span>${restaurant.name}</span>
                <span>Created: ${restaurant.created_at}</span>
                <span>Entries: ${restaurant.menus.length}</span>
            `;
            restaurantDiv.appendChild(headerDiv);

            // Expandable details section
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'restaurant-details';
            detailsDiv.id = `details-${restaurant.id}`;
            detailsDiv.style.display = 'none';

            // Add menu versions
            restaurant.menus.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach((menu) => {
                const menuDiv = document.createElement('div');
                menuDiv.className = 'menu-version';
                menuDiv.onclick = () => loadMenuVersion(menu.menu_id);
                
                const menuContent = document.createElement('div');
                menuContent.style.display = 'flex'; // Use flexbox to spread items
                menuContent.style.justifyContent = 'space-between'; // Spread items across the div
                menuContent.style.alignItems = 'center'; // Align items vertically in the center
                menuContent.style.flex = '1';
                menuContent.style.marginRight = '10px';

                menuContent.innerHTML = `
                    <span><strong>Created:</strong> ${menu.created_at}</span>
                    <span><strong>Description:</strong> ${menu.description || 'No description provided'}</span>
                    <span><strong>Status:</strong> ${menu.status}</span>
                `;

                // Buttons
                const buttonContainer = document.createElement('div');

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete'
                deleteButton.textContent = 'Delete';
                deleteButton.style.backgroundColor = '#dc3545';
                deleteButton.style.color = '#fff';
                deleteButton.style.border = 'none';
                deleteButton.style.borderRadius = '5px';
                deleteButton.style.padding = '5px 10px';
                deleteButton.style.cursor = 'pointer';
                deleteButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent triggering the parent onclick event
                    deleteMenu(menu.menu_id);
                };
                buttonContainer.appendChild(deleteButton);

                menuDiv.appendChild(menuContent);
                menuDiv.appendChild(buttonContainer);

                detailsDiv.appendChild(menuDiv);
            });

            restaurantDiv.appendChild(detailsDiv);
            container.appendChild(restaurantDiv);
        });

        function editMenu(menuId) {
            console.log('Edit menu:', menuId);
        }

        function deleteMenu(menuId) {
            console.log(menuId)
            fetch("{% url 'delete_menu' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({
                    "menu_id": menuId 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message); 
                // Auto refresh page?
            })
            .catch(error => console.error('Error:', error));
        }


    </script>

    <footer class="footer">
        <div class="container">
            <nav>
                <ul class="git">
                    <li><a href="https://github.com/studentBorisGans/menuDatabase.git">GitHub</a></li>
                    <li><a href="https://github.com/studentBorisGans/menuDatabase.git">Documentation</a></li>
                </ul>
            </nav>
        </div>
    </footer>
</body>
</html>